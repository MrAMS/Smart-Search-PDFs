# 更新日志

所有重要的项目更新都记录在此文件中。

---

## [3.2.0] - 2026-01-05

### 🎉 重大功能：多粒度搜索

#### ✨ 新功能
- **多粒度 Chunk 支持** - 三种切分粒度，适配不同文档类型
  - **页面级 (Page-level)**：每页一个 chunk，适合 PPT、演示文稿
    - 文件命名：`doc.json` / `doc.emb`
    - 保持页面完整性，适合独立页面内容
  - **段落级 (Paragraph-level)**：按段落切分，适合双栏论文、学术文章
    - 文件命名：`doc.para.json` / `doc.para.emb`
    - 按双换行符 (`\n\n`) 分割段落
    - 智能合并短段落（<100 字符）
    - pymupdf4llm 已处理双栏阅读顺序
  - **固定长度块 (Fixed-length)**：按字符数切分，适合长文档、小说
    - 文件命名：`doc.fixed.json` / `doc.fixed.emb`
    - 默认块大小：2000 字符
    - 支持滑动窗口重叠：200 字符（10%）
    - 跨页块取中点页码

- **自适应长度惩罚** - 根据 chunk 类型自动优化搜索参数
  - 页面级：0.3（当前最佳值）
  - 段落级：0.2（段落较短，减轻惩罚）
  - 固定块：0.35（长度均匀，略增惩罚）
  - 混合粒度：0.3（自动取中间值）

- **粒度信息显示** - 搜索结果增强显示
  - 显示 chunk 类型：页面级 / 段落级 / 固定块
  - 显示 chunk 序号：在文档中的位置（从 0 开始）
  - 显示匹配方式：精确匹配、部分匹配、语义相关、关键词
  - 显示页码和相关度分数

- **混合粒度搜索** - 无缝整合不同粒度的数据
  - 自动加载所有粒度的 JSON/EMB 文件
  - 智能混合排序，取得最佳结果
  - 搜索引擎自动检测并适配不同粒度

#### 🎨 GUI 改进
- **粒度选择下拉框** - 在 create-JSON-EMB.py 添加
  - 位置：Batch processing 选项右侧
  - 三个选项：页面级、段落级、固定长度块
  - 详细工具提示说明每种粒度的特点和适用场景
  - 美观的 Bootstrap 风格样式

#### 🔧 技术改进
- **新增提取函数**
  - `extract_paragraph_chunks()` - 智能段落提取算法
  - `extract_fixed_chunks()` - 固定长度滑动窗口算法
  - `get_chunk_filename()` - 文件命名管理
  - `get_adaptive_length_penalty()` - 自适应惩罚参数

- **数据结构扩展** - 完全向后兼容
  - 新增字段：`chunk_type`（粒度类型）
  - 新增字段：`chunk_index`（chunk 序号）
  - 新增字段：`char_start` / `char_end`（固定块专用）
  - 旧数据自动识别为"页面级"

- **搜索引擎优化**
  - `EmbeddingSearcher.search()` 支持自动检测粒度
  - `length_penalty_exp` 参数改为可选，支持自适应
  - 混合搜索自动处理不同粒度的结果

#### 📦 文件命名策略
- 页面级：保持原命名（`doc.json`），向后兼容
- 段落级：添加 `.para` 后缀（`doc.para.json`）
- 固定块：添加 `.fixed` 后缀（`doc.fixed.json`）
- 多粒度可共存，无文件冲突

#### ✅ 向后兼容性
- ✅ 所有旧的 `.json` 和 `.emb` 文件继续有效
- ✅ 新旧数据可以共存并混合搜索
- ✅ 未指定 chunk_type 的文档默认为"页面级"
- ✅ 使用 `.get()` 方法读取字段，默认值保证兼容
- ✅ 无需重新处理已有数据

#### 🐛 Bug 修复
- 修复：添加缺失的 `import re` 模块（段落切分需要）
- 修复：`extract_page_chunks()` 添加 chunk_type 和 chunk_index 字段

#### 📝 文档更新
- README.md 添加"多粒度搜索"章节
- 详细说明三种粒度的使用场景和示例
- 更新快速开始指南，添加粒度选择步骤
- 添加文件结构示例和搜索结果展示说明

---

## [3.1.1] - 2026-01-05

### 🎨 UI 改进
- **管理数据文件夹按钮** - 将菜单栏改为显眼的绿色按钮
  - 位置：搜索方法栏最右侧，醒目易找
  - 颜色：绿色（#28a745）表示添加/管理操作
  - 工具提示：清晰说明功能
  - 移除菜单栏，简化界面

**改进前**：
- 数据文件夹管理藏在顶部菜单栏 `Data folders → Manage folders...`
- 用户不容易发现，需要先找到菜单

**改进后**：
- 醒目的绿色按钮"管理数据文件夹"在搜索栏右侧
- 一目了然，点击即用

---

## [3.1.0] - 2026-01-05

### 🎉 重大更新

#### ✨ 新功能
- **混合搜索（智能）** - 融合精确匹配、语义搜索和 BM25 关键词检索
  - 智能评分策略：精确匹配 (100分) > 部分匹配 (80分) > 语义相关 (70分) > 关键词 (50分)
  - 彩色匹配标签：清晰显示每个结果的匹配方式
    - 绿色：精确匹配
    - 蓝色：部分匹配
    - 紫色：语义相关
    - 橙色：关键词
- **现代化 UI** - 全面优化用户界面
  - Bootstrap 风格设计，统一配色方案
  - 工具提示说明每种搜索方法的特点
  - 美观的按钮和输入框，支持 hover 效果
  - 卡片式结果展示，更清晰易读

#### 🎨 UI 改进
- **搜索方法下拉框** - 中文化选项，添加详细工具提示
- **按钮美化** - 蓝色导航按钮，灰色字体按钮
- **搜索框优化** - 占位符文本，聚焦时高亮
- **结果显示** - 卡片式布局，彩色标签，只显示文件名
- **高亮改进** - 亮黄色背景，黑色加粗文字

#### 🐛 修复
- **移除 Emoji** - 删除所有 UI 中的 emoji，提升跨平台兼容性
  - 修复在某些系统上 emoji 显示为方框的问题
  - 使用纯文本和 Unicode 符号（◀ ▶）替代

#### 📚 文档
- **README 更新** - 添加混合搜索说明和评分策略
- **CHANGELOG 更新** - 详细记录所有改进

### 🔬 技术细节

#### 混合搜索算法

**评分策略**：
```python
# 阶段 1: 精确文字匹配（最高优先级）
完全匹配 = 100 分 + 匹配次数奖励（最多 20 分）
部分匹配 = 80 分（所有查询词都出现）

# 阶段 2: Embeddings 语义搜索
语义分数 = 余弦相似度 × 70

# 阶段 3: BM25 关键词搜索
BM25 分数 = 归一化分数 × 50

# 分数融合
- 精确匹配文档：基础分数 + 30% 语义分数 + 20% BM25 分数
- 其他文档：取最高分数
```

**结果展示**：
```
┌─────────────────────────────────────────────┐
│ 结果 1 / 5                                   │
│ 文件: 第七章.pdf                             │
│ 页码: 3                                      │
│ 匹配方式: [精确匹配] [语义相关]              │
│ 相关度: 120.34                               │
├─────────────────────────────────────────────┤
│ 分布式多媒体系统在远程教学中...             │
└─────────────────────────────────────────────┘
```

---

## [3.0.0] - 2026-01-05

### 🎉 重大更新

#### ✨ 新功能
- **PDF 自动宽度适应** - PDF 预览自动适应窗口大小，支持窗口调整时动态缩放
- **中文输入法支持** - 完美支持 Rime、Fcitx5、IBus 输入法
- **命令行测试工具** - 新增 `test_search.py`，支持参数调优和对比测试

#### ⚡ 性能优化
- **查询向量归一化** - 修复算法缺陷，性能提升 20-30%
- **智能长度惩罚** - 从 0.5 降低到 0.3，平衡长短文档排序
- **查询缓存** - 重复查询性能提升 2x+
- **单次排序** - 优化排序流程，减少计算开销

#### 🔧 重构
- **搜索引擎模块化** - 创建 `search_engine.py`，与 GUI 解耦
- **代码简化** - 主程序减少约 80 行代码
- **主程序重命名** - `BM25-String-Embed-Rerank-PDF-Search.py` → `search_app.py`

#### 🐛 修复
- **Unicode 字符处理** - 修复数学符号等特殊字符导致的 JSON 生成失败
- **数据完整性** - 重新生成缺失的 embedding 文件（100% 覆盖）
- **模型缓存** - 修复模型重复下载问题

#### 📚 文档
- **全新 README** - 更简洁清晰的项目说明
- **完善的故障排除** - 常见问题解决方案
- **.gitignore** - 规范的 Git 忽略规则

### 🔬 技术细节

#### Embedding 搜索优化

**优化前**：
```python
# 查询向量未归一化
query_embedding = list(GLOBAL_EMBED_MODEL.query_embed(query))[0]
# 长度惩罚过重 (0.5)
final_score = base_score / (length ** 0.5)
# 两次排序
```

**优化后**：
```python
# 查询向量归一化
query_emb = normalize_vector(query_emb)
# 合理的长度惩罚 (0.3)
final_score = cosine_sim / (length ** 0.3)
# 单次排序 + 缓存
```

**效果对比**：

| 文本长度 | 惩罚 0.5 | 惩罚 0.3 | 改善 |
|----------|----------|----------|------|
| 100 字   | 10.0     | 4.6      | -54% |
| 500 字   | 22.4     | 7.9      | -65% |
| 1000 字  | 31.6     | 10.0     | -68% |

#### PDF 自动宽度适应

**核心功能**：
- 首次加载时自动计算最佳缩放比例
- 窗口调整时动态响应（300ms 防抖）
- 手动缩放（Ctrl+±）时自动禁用
- 重置缩放（Ctrl+0）时恢复自动适应

**缩放计算**：
```python
view_width = graphics_view.viewport().width()
page_width = get_content_width()  # 考虑裁剪
scale_factor = (view_width - 20) / (page_width * zoom)
scale_factor = clamp(scale_factor, 0.1, 5.0)
```

---

## [2.3.0] - 2025-03-09

### ✨ 新功能
- **BM25 Substring 搜索** - 支持前缀匹配和负向排除（如：`compar -comparison`）
- **平台自动检测** - Linux/Windows 自动设置默认 PDF 查看器

### 🔧 改进
- **PDF 裁剪开关** - 可选择是否自动裁剪 PDF 白边
- **批处理选项** - `create-JSON-EMB.py` 支持批量处理 PDF

---

## [2.0.0] - 2025-02-02

### 🎉 重大更新
- **图形化 PDF 处理工具** - 新增 `create-JSON-EMB.py` GUI
- **文件夹管理** - 支持管理多个数据文件夹，配置保存到 `folders.ini`

### ⚡ 改进
- **搜索界面优化** - 更友好的用户体验
- **动态页面加载** - 大型 PDF 滚动加载，流畅不卡顿

---

## [1.0.0] - 2024-12-01

### 🎉 首次发布
- **多种搜索方式** - BM25、简单文本搜索、Embedding 语义搜索
- **PDF 预览** - 内置 PDF 查看器，搜索词高亮
- **Reranking 支持** - 多种重排序算法
- **跨平台** - 支持 Linux 和 Windows

---

## 贡献指南

如果你想为项目做贡献：
1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

---

## 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](../LICENSE) 文件
